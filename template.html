<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CreditCow Sync</title>
    <style>
      h1 { font-family: 'Courier New', Courier, monospace; margin: 0; }
      h1.primary { height: 10vh; display: flex; align-items: center; justify-content: center; font-size: 6vh; }
      h1.secondary { height: 5vh; display: flex; align-items: center; justify-content: center; font-size: 3vh; }
      .controls { margin: 12px 0; text-align: center; }
      .auth-box { background: #f4f4f4; padding: 15px; margin: 10px auto; border-radius: 8px; text-align: center; max-width: 400px; }
      #tokenInput { width: 90%; padding: 8px; margin-top: 5px; }
    </style>
</head>
<body>
    
    <h1 class="primary">DEBUG's CreditCow</h1>
    <h1 class="secondary">Your public receiver ID: 1</h1>

    <div class="auth-box">
      <label for="tokenInput"><b>Step 1: Enter GitHub Token</b></label><br>
      <input type="password" id="tokenInput" placeholder="ghp_xxxxxxxxxxxx">
      <p style="font-size: 11px; color: #d93025;">Ensure token has 'repo' scope checked!</p>
    </div>

    <div class="controls">
      <button id="btn-add">Add 1 to send</button>
      <button id="btn-subtract">Subtract 1 from send</button>
    </div>

    <h1 id="output-area1" class="secondary">0</h1>
    
    <div style="text-align: center; margin-top: 20px;">
      <label for="sendID"><b>Step 2: Target File ID</b></label><br>
      <input type="text" id="sendID" placeholder="e.g., 2">
      <button id="submitBtn" type="button" style="padding: 10px 20px; background: #2ea44f; color: white; border: none; border-radius: 6px; cursor: pointer;">Submit & Sync</button>
    </div>

  <script>
    let sendTotal = 0;
    const btnSubmit = document.getElementById('submitBtn');
    const inputID = document.getElementById('sendID');
    const tokenInput = document.getElementById('tokenInput');
    const out = document.getElementById("output-area1");
    const btnSub = document.getElementById("btn-subtract");

    function updateDisplay() {
      out.textContent = sendTotal;
      btnSub.disabled = sendTotal <= 0;
    }

    document.getElementById("btn-add").addEventListener("click", () => {
      sendTotal++;
      updateDisplay();
    });

    btnSub.addEventListener("click", () => {
      if (sendTotal > 0) {
        sendTotal--;
        updateDisplay();
      }
    });

    async function subtractAndSync(targetID) {
      const GITHUB_TOKEN = tokenInput.value.trim();
      const OWNER = 'coolgames555';
      const REPO = 'CreditCow';
      const PATH = `data/${targetID}.txt`; 
      
      // FIXED: Added /repos/ and used backticks for proper variable interpolation
      const url = `https://api.github.com{OWNER}/${REPO}/contents/${PATH}`;
      
      console.log("Requesting URL:", url);

      if (!GITHUB_TOKEN) return alert("Please enter a token first!");

      try {
        // 1. GET current content
        const response = await fetch(url, {
          method: 'GET',
          headers: { 
            "Authorization": `Bearer ${GITHUB_TOKEN}`,
            "Accept": "application/vnd.github.v3+json"
          }
        });
        
        if (!response.ok) {
          const errorMsg = await response.json();
          throw new Error(`GitHub Error (${response.status}): ${errorMsg.message}`);
        }

        const fileData = await response.json();
        const currentVal = parseFloat(atob(fileData.content)) || 0; 
        const newVal = (currentVal + sendTotal).toString(); 

        // 2. PUT updated content
        const updateRes = await fetch(url, {
          method: 'PUT',
          headers: {
            "Authorization": `Bearer ${GITHUB_TOKEN}`,
            "Content-Type": "application/json",
            "Accept": "application/vnd.github.v3+json"
          },
          body: JSON.stringify({
            message: `Sync: Added ${sendTotal} to ${targetID}.txt`,
            content: btoa(newVal),
            sha: fileData.sha // Required to update an existing file
          })
        });

        if (updateRes.ok) {
          alert(`Success! Updated ${targetID}.txt to ${newVal}`);
          sendTotal = 0;
          updateDisplay();
        } else {
          const err = await updateRes.json();
          throw new Error(`Push Failed: ${err.message}`);
        }
      } catch (error) {
        console.error("Critical Error:", error);
        alert(error.message);
      }
    }

    btnSubmit.addEventListener('click', function() {
      const targetID = inputID.value.trim();
      if (!targetID) return alert("Please enter a Target ID");
      subtractAndSync(targetID);
    });

    updateDisplay();
  </script>
</body>
</html>
