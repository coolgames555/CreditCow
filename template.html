<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CreditCow Sync</title>
    <style>
      h1 { font-family: 'Courier New', Courier, monospace; margin: 0; }
      h1.primary { height: 10vh; display: flex; align-items: center; justify-content: center; font-size: 6vh; }
      h1.secondary { height: 5vh; display: flex; align-items: center; justify-content: center; font-size: 3vh; }
      .controls { margin: 12px 0; text-align: center; }
      .auth-box {  padding: 10px; margin-bottom: 20px; border-radius: 8px; text-align: center; }
      #tokenInput { width: 300px; padding: 5px; }
    </style>
</head>
<body>
    
    <h1 class="primary">DEBUG's CreditCow</h1>
    <h1 class="secondary">Your public receiver ID: 1</h1>
    <h1> Git Token (copy paste): ghp_sEnOW3xpk1KaQhsEi<br>zwYyydVbt8DF22GZ72L </h1>

    <!-- Token box to prevent auto-expiry -->
    <div class="auth-box">
      <label for="tokenInput">GitHub Token:</label>
      <input type="password" id="tokenInput" placeholder="Paste ghp_ token here">
      <p style="font-size: 10px; color: #666;">Tokens are not saved. Paste your token each time you refresh.</p>
    </div>

    <div class="controls">
      <button id="btn-add">Add 1 to send</button>
      <button id="btn-subtract">Subtract 1 from send</button>
    </div>

    <h1 id="output-area1" class="secondary">0</h1>
    
    <div style="text-align: center;">
      <label for="sendID">Target File ID:</label>
      <input type="text" id="sendID" placeholder="e.g. 2">
      <button id="submitBtn" type="button">Submit & Sync</button>
    </div>

  <script>
    let sendTotal = 0;
    const btnSubmit = document.getElementById('submitBtn');
    const inputID = document.getElementById('sendID');
    const tokenInput = document.getElementById('tokenInput');
    const out = document.getElementById("output-area1");
    const btnSub = document.getElementById("btn-subtract");

    function updateDisplay() {
      out.textContent = sendTotal;
      btnSub.disabled = sendTotal <= 0;
    }

    document.getElementById("btn-add").addEventListener("click", () => {
      sendTotal++;
      updateDisplay();
    });

    btnSub.addEventListener("click", () => {
      if (sendTotal > 0) {
        sendTotal--;
        updateDisplay();
      }
    });

    async function subtractAndSync(targetID) {
      const GITHUB_TOKEN = tokenInput.value.trim();
      const OWNER = 'coolgames555';
      const REPO = 'CreditCow';
      const PATH = `data/${targetID}.txt`; 
      const url = `https://api.github.com${OWNER}/${REPO}/contents/${PATH}`;

      if (!GITHUB_TOKEN) {
        alert("Please paste your GitHub Token first!");
        return;
      }

      try {
        // 1. Fetch current file
        const response = await fetch(url, {
          headers: { 
            "Authorization": `token ${GITHUB_TOKEN}`,
            "Accept": "application/vnd.github.v3+json"
          }
        });
        
        if (!response.ok) {
          throw new Error(`File ${targetID}.txt not found or Token invalid (Error ${response.status})`);
        }

        const fileData = await response.json();
        const currentVal = parseFloat(atob(fileData.content)) || 0; 
        
        // Per your logic: Adding sendTotal to the file's current number
        const newVal = (currentVal + sendTotal).toString(); 

        // 2. Push update
        const updateRes = await fetch(url, {
          method: 'PUT',
          headers: {
            "Authorization": `token ${GITHUB_TOKEN}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            message: `Web Sync: Added ${sendTotal} to ${targetID}.txt`,
            content: btoa(newVal),
            sha: fileData.sha
          })
        });

        if (updateRes.ok) {
          alert(`Successfully updated! New value: ${newVal}`);
          sendTotal = 0;
          updateDisplay();
        } else {
          const err = await updateRes.json();
          throw new Error(err.message);
        }
      } catch (error) {
        console.error(error);
        alert(error.message);
      }
    }

    btnSubmit.addEventListener('click', function() {
      const targetID = inputID.value.trim();
      if (!targetID) return alert("Please enter a Target ID");
      subtractAndSync(targetID);
    });

    updateDisplay();
  </script>
</body>
</html>
